# Fix Code Block Contrast for Accessibility (WCAG 2.1 AA)

**Issue:** [#886](https://github.com/processing/p5.js-website/issues/886)
**Pull Request:** [p5.js-website PR #998](https://github.com/processing/p5.js-website/pull/998)

## Problem

Code blocks on the site, especially the `function` keyword, had **insufficient text-to-background contrast**:

- Example: `#D73A49` (red) on `#F7F7F7` (light gray) yields a contrast ratio of **4.26:1**, below the WCAG 2.1 AA minimum of 4.5:1 for normal text.
- Shiki syntax highlighter was generating **correct high-contrast colors**, but downstream CSS (e.g., `.code-box`, `bg-bg-gray-40`) overrode the background or text colors, muting the theme.
- axe DevTools flagged `<span style="color:#D73A49">function</span>` as a **serious accessibility issue**.

---

## Objective

- Ensure all code blocks meet **WCAG 2.1 AA contrast requirements**.
- Respect Shiki’s high-contrast theme outputs.
- Remove temporary CSS patches that forced colors manually.
- Maintain current site layout and code block styling without regressions.

---

## Solution

1. **Removed `bg-bg-gray-40` class** from code block containers to prevent light gray backgrounds from overriding the theme.
2. **Set `.code-box` background to pure white (`#fff`)** in global styles to maximize contrast.
3. **Ensured no CSS rules override Shiki's inline code colors**.
4. **Deleted old manual patch** (`code span[style*="#D73A49"] { color: #000 !important; }`).
5. Cleaned up redundant styles by removing `code-contrast-fix.scss` and its import.

---

## Technical Challenges

- Existing CSS rules were overriding Shiki inline styles (`!important`, utility classes).
- Needed to verify all `.code-box` and `.astro-code` rules were not interfering.
- Ensured changes did not regress any site layout or dark/light theme behavior.

---

## Changes Made

- Edited `src/components/CodeContainer/index.astro` to remove `bg-bg-gray-40` from code block classes.
- Updated `styles/global.scss`:

  ```css
  .code-box {
    background-color: #fff !important;
  }
  ```

  Removed import of `code-contrast-fix.scss`.

- Deleted `src/styles/code-contrast-fix.scss`.
- Verified no other color overrides exist for `.code-box` or `.astro-code` in the codebase.

---

## How We Verified

1. Rebuilt the site and cleared browser cache.
2. Ran **axe DevTools** on `/tutorials/get-started/`:
   - Contrast issue for code blocks no longer reported.

3. Inspected DOM:
   - `.code-box` background is white.
   - Shiki’s inline colors for code tokens are correctly applied.

4. Confirmed visual layout is unaffected.
5. Checked other pages to ensure consistency across the site.

---

## Maintainer Comments & Cherry-Pick Process

- The fix was developed in the `2.0` branch and verified locally.
- Cherry-picked the specific commit(s) into `main` to ensure the fix is available on the production branch.
- Cherry-pick was successful, no conflicts, and the fix applied cleanly.
- Temporary local branches used for verification were deleted after merge.

---

## Related Issue

Closes #886

---

## Additional Notes

- No visual regressions expected; code block layout remains intact.
- Other accessibility issues (button labels, link distinction, heading order, landmarks) remain and will be addressed in separate follow-up PRs.
